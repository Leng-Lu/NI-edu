
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Run-level analyses &#8212; NI-edu</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Group-level analyses" href="../../section_intros/6_grouplevel.html" />
    <link rel="prev" title="First-level analyses (using FSL)" href="first_level_analyses.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/fmri.gif" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">NI-edu</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../index.html">
   Welcome to NI-edu
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Getting started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../getting_started/about.html">
   About this course
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../getting_started/installation.html">
   Installation
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  fMRI-introduction
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../section_intros/1_python.html">
   Python for (f)MRI analysis
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../other/python_recap.html">
     Python recap
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_1/python_for_mri.html">
     Working with MRI data in Python (T)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../section_intros/2_glm.html">
   Using the GLM to model fMRI data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_2/glm_part1_estimation.html">
     The GLM: estimation (T)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_3/glm_part2_inference.html">
     The GLM: inference (T)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../section_intros/3_design_of_experiments_T.html">
   Design of experiments
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_3/design_of_experiments.html">
     Design of experiments (T)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_3/neurodesign.html">
     Neurodesign (T)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../section_intros/4_preprocessing.html">
   Preprocessing
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_4/temporal_preprocessing.html">
     Temporal preprocessing (T)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_4/spatial_preprocessing.html">
     Spatial preprocessing (T)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_4/fmriprep.html">
     Fmriprep (T)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../../section_intros/5_multilevel.html">
   First &amp; run-level analyses
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="linux_and_the_command_line.html">
     Linux and the CMD (T)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="first_level_analyses.html">
     First level analyses (T)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Run-level analyses (T)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../section_intros/6_grouplevel.html">
   Group-level analyses
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_6/group_level_analyses.html">
     Group-level analyses (T)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_6/MCC.html">
     Multiple comparison correction (T)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_6/ROI_analysis.html">
     ROI analysis (T)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../section_intros/7_nilearn.html">
   Introduction to Nilearn
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_7/nilearn.html">
     Introduction to Nilearn (T)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../week_7/nilearn_stats.html">
     Statistics with Nilearn (T)
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  fMRI-pattern-analysis
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../fMRI-pattern-analysis/week_1/design_and_pattern_estimation.html">
   Design and pattern estimation (T)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fMRI-pattern-analysis/week_2/decoding_analyses.html">
   Machine learning/decoding (T)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fMRI-pattern-analysis/week_3/rsa.html">
   Representational Similarity Analysis (T)
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Misc
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../misc/bibliography.html">
   Bibliography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../misc/for_educators.html">
   For educators
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../misc/CONTRIBUTING.html">
   Contributing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../misc/CONDUCT.html">
   Code of Conduct
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/fMRI-introduction/week_5/run_level_analyses.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/lukassnoek/NI-edu"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/lukassnoek/NI-edu/issues/new?title=Issue%20on%20page%20%2FfMRI-introduction/week_5/run_level_analyses.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/lukassnoek/NI-edu/edit/master/NI-edu/fMRI-introduction/week_5/run_level_analyses.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/lukassnoek/NI-edu/master?urlpath=tree/NI-edu/fMRI-introduction/week_5/run_level_analyses.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        <a class="jupyterhub-button" href="https://neuroimaging.lukas-snoek.com/hub/user-redirect/git-pull?repo=https://github.com/lukassnoek/NI-edu&urlpath=tree/NI-edu/NI-edu/fMRI-introduction/week_5/run_level_analyses.ipynb&branch=master"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch JupyterHub" data-toggle="tooltip"
                data-placement="left"><img class="jupyterhub-button-logo"
                    src="../../_static/images/logo_jupyterhub.svg"
                    alt="Interact on JupyterHub">JupyterHub</button></a>
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   Run-level analyses
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-traditional-multilevel-model">
     The traditional multilevel model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-summary-statistics-approach">
     The summary statistics approach
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fixed-vs-random-vs-mixed-effects">
     Fixed vs. random vs. mixed effects
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-level-analyses-in-fsl">
     Run-level analyses in FSL
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#checking-out-results-from-run-level-feat-analyses">
   Checking out results from run-level FEAT analyses
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="run-level-analyses">
<h1>Run-level analyses<a class="headerlink" href="#run-level-analyses" title="Permalink to this headline">¶</a></h1>
<p>In this notebook, we will explain how to aggregate data from different fMRI runs using “run-level analyses”. We will use both simulated and real data to explain this concept and show how to implement this in Python as well as FSL.</p>
<p>If you haven’t done the other two notebooks (<code class="docutils literal notranslate"><span class="pre">linux_and_the_CMD.ipynb</span></code> and <code class="docutils literal notranslate"><span class="pre">first_level_analyses.ipynb</span></code> yet), please go through these first.</p>
<p><strong>What you’ll learn</strong>: after this lab, you’ll be able to …</p>
<ul class="simple">
<li><p>set up a run-level model in FSL FEAT</p></li>
</ul>
<p><strong>Estimated time needed to complete</strong>: 1-2 hours</p>
<div class="section" id="id1">
<h2>Run-level analyses<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>More often than not, researchers split their experiment across different fMRI <em>runs</em> (a period of continuous fMRI acquisition). These runs may be grouped within a particular <em>session</em> (a set of MRI scans within a particular period that the participant is in the scanner) or split across different sessions (e.g., run 1 and 2 are done on day 1, and run 3 and 4 are done on day 2).</p>
<div class='alert alert-info'>
<b>ToDo</b> (1 point): Name one reason why researchers often rather split their experiment across different runs than having a single (longer) run. 
</div><p>YOUR ANSWER HERE</p>
<p>As discussed before, splitting your experiment in different runs (across multiple sessions) generates a new “level” within data. If we analyzed each run/session in separate first-level models, we need to somehow aggregate (or average) the effects (<span class="math notranslate nohighlight">\(c\hat{\beta}\)</span>) and their variance (<span class="math notranslate nohighlight">\(\mathrm{var}[c\hat{\beta}]\)</span>) across these different runs. <strong>If your experiment indeed contains multiple runs, then the next step in the “summary statistics” approach will be to combine their results</strong>.</p>
<p>Before discussing how the summary statistics approach would be implemented for fMRI data with multiple runs, let’s focus on how a “traditional” hierarchical/multilevel model for this type of data would look like.</p>
<div class="section" id="the-traditional-multilevel-model">
<h3>The traditional multilevel model<a class="headerlink" href="#the-traditional-multilevel-model" title="Permalink to this headline">¶</a></h3>
<p>In traditional hierarchical/multilevel (frequentists) GLM models, the data (<span class="math notranslate nohighlight">\(y\)</span>) and design matrices (<span class="math notranslate nohighlight">\(\mathbf{X}\)</span>) across different levels are simply concatenated. For example, for single-subject fMRI data with multiple runs, the signals (<span class="math notranslate nohighlight">\(y\)</span>) and design matrices (<span class="math notranslate nohighlight">\(\mathbf{X}\)</span>) are concatenated in time.</p>
<p>We’ll show you how this is done for some example data. For example, suppose we have an experimental paradigm with two conditions (“A” and “B”), which we spread over 4 runs of 200 seconds/volumes (assuming a TR of 1 for simplicity).</p>
<p>We’ll generate such a signal below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">niedu.utils.nii</span> <span class="kn">import</span> <span class="n">simulate_signal</span>  <span class="c1"># ignore the warning!</span>

<span class="n">duration</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">onsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">n_run</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">Xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_run</span><span class="p">):</span>  <span class="c1"># simulate 4 signals / design matrices</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">simulate_signal</span><span class="p">(</span>
        <span class="n">onsets</span><span class="o">=</span><span class="n">onsets</span><span class="p">,</span> <span class="n">conditions</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">onsets</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">TR</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span> <span class="n">params_canon</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">std_noise</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rnd_seed</span><span class="o">=</span><span class="n">run</span>
    <span class="p">)</span>
    <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">Xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># remove tderivs</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of signals: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Size of signal for each run: </span><span class="si">%i</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of design matrices: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xs</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of design matrix per run: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of signals: 4
Size of signal for each run: 200

Number of design matrices: 4
Shape of design matrix per run: (200, 3)
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the signals from the separate runs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_run</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>    
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_run</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_run</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Time (sec.)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Run&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/run_level_analyses_8_0.png" src="../../_images/run_level_analyses_8_0.png" />
</div>
</div>
<p>To create a “traditional” multilevel model, we need to concatenate the signals (<span class="math notranslate nohighlight">\(y\)</span>) in time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Size of signal: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>

<span class="c1"># Let&#39;s plot the concatenated signal (but color-code the runs)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ytmp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ys</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">duration</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ytmp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Time (sec.)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Signal amplitude (A.U.)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Size of signal: 800
</pre></div>
</div>
<img alt="../../_images/run_level_analyses_10_1.png" src="../../_images/run_level_analyses_10_1.png" />
</div>
</div>
<p>Similarly, we need to stack the run-wise design matrices, but these are stacked both vertically (in time) and horizontally (as separate predictors). In other words, each predictor (including the intercept!) in each run gets its own column (i.e., predictor) in our multilevel design matrix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span> <span class="o">*</span> <span class="n">duration</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xs</span><span class="p">)):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">duration</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">X</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
<span class="c1"># number of columns = number of conditions * number of runs</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of concatenated design matrix: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape of concatenated design matrix: (800, 12)
</pre></div>
</div>
</div>
</div>
<p>It’s probably easier to understand it if it’s plotted. Below, we’ll plot the concatenated signal (<span class="math notranslate nohighlight">\(y_{all}\)</span>) and the concatenated design matrix (<span class="math notranslate nohighlight">\(X_{all}\)</span>) in a single figure:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">Xs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ytmp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ys</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">duration</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ytmp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="n">n_run</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$X_{run\ </span><span class="si">%i</span><span class="s2">}$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="n">n_run</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pred</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span>
        <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$icept_{</span><span class="si">%i</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;$A_{</span><span class="si">%i</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="sa">r</span><span class="s1">&#39;$B_{</span><span class="si">%i</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span>
    <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.61</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$X_</span><span class="si">{all}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y_</span><span class="si">{all}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.045</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Time (volumes)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/run_level_analyses_14_1.png" src="../../_images/run_level_analyses_14_1.png" />
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (2 points)
<p>Given the concatenated signal (the variable <tt>y</tt>) and concatenated design matrices (the variable <tt>X</tt>), you can run a single GLM to get the parameters for the different conditions across the four runs (i.e., <span class="math notranslate nohighlight">\(icept_{1}\)</span>, <span class="math notranslate nohighlight">\(icept_{2}\)</span>, <span class="math notranslate nohighlight">\(A_{1}\)</span>, <span class="math notranslate nohighlight">\(A_{2}\)</span>, <span class="math notranslate nohighlight">\(B_{1}\)</span>, <span class="math notranslate nohighlight">\(B_{2}\)</span>, etc.). Do this for our data (using <tt>y</tt> and <tt>X</tt>) and store the estimated parameters (there should be 12) in a new variable named <tt>av_betas</tt>.</p>
<p>Then, you can in fact specify a specific contrast vector that gives you the <em>average</em> effect (i.e., <span class="math notranslate nohighlight">\(\hat{\beta}_{A}\)</span> or <span class="math notranslate nohighlight">\(\hat{\beta}_{B}\)</span>). Try to think of which particular contrast (which should also be of size 12) would “compute” the average effect. Create a separate contrast vector for the average effect of A (store this in a variable named <tt>cvec_a</tt>) and the average effect of B (store this in a variable named <tt>cvec_b</tt>).</p>
<p>Hint: you can of course check whether your contrast-vectors in fact yield the mean effect (<span class="math notranslate nohighlight">\(\hat{\beta}\)</span>) by comparing it to the result when you manually compute the mean!</p>
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">inv</span>

<span class="c1"># Implement the ToDo here!</span>
<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">niedu.tests.nii.week_5</span> <span class="kn">import</span> <span class="n">test_ffx_glm</span>
<span class="n">test_ffx_glm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">av_betas</span><span class="p">,</span> <span class="n">cvec_a</span><span class="p">,</span> <span class="n">cvec_b</span><span class="p">,</span> <span class="n">n_run</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, the previous ToDo only concerned the estimation of the run-average <em>effects</em> (and the contrast), but not the estimation of the <em>variance of the run-average effect</em>. The exact way this is computed actually depends on whether you want to use a fixed-effect, random-effect, or mixed-effects approach. We will discuss this later in this notebook. First, let’s take a look at how fMRI studies usually deal with multilevel data: using the summary statistics approach.</p>
</div>
<div class="section" id="the-summary-statistics-approach">
<h3>The summary statistics approach<a class="headerlink" href="#the-summary-statistics-approach" title="Permalink to this headline">¶</a></h3>
<p>Most fMRI studies dealing with multilevel data often do not use the traditional multilevel model, but use a slightly different approach: instead of running one single GLM for the concatenated data, it runs a GLM <em>per</em> unit within each level and subsequently “averages” the contrast estimates using the “summary statistics” approach. For example, for multi-run data, a first-level model for each separate run is evaluated (instead of a single, concatenated model). This is also the approach FSL takes.</p>
<p>After estimating a first-level model for each run separately, the summary statistics approach uses the results (i.e., <span class="math notranslate nohighlight">\(c\hat{\beta}\)</span>, representing the “summary statistics”) of the previous level as the “data-to-be-explained” (i.e., <span class="math notranslate nohighlight">\(y\)</span>) within the current level. Using a “run-level” GLM with a new design matrix, the data from the previous level can be aggregated as desired, where the results (i.e., <span class="math notranslate nohighlight">\(c\hat{\beta}\)</span>) of the <em>current</em> level GLM represent the aggregated data. This is both the case for aggregating results across runs (in run-level analyses) and across subjects (in group-level analyses). The global idea of this summary statistics approach is visualized in the figure below.</p>
<p><img alt="" src="https://docs.google.com/drawings/d/e/2PACX-1vQxCH3WU3nTqFlHUZb49rf9zioivGQ-flVfRpwmXQx7OF5Wm_1T6gFMYQqpqt-NPITNHUaRoVYEREgT/pub?w=1442&amp;h=1168" /></p>
<p>To put it another way, to aggregate first-level results across runs, we are going to construct another GLM at the “run-level”. To distinguish components of run-level GLMs from first-level GLMs, we will add a superscript asterisk (<span class="math notranslate nohighlight">\(^{*}\)</span>) to the run-level GLM components.</p>
<p>So, in our run-level GLM, the first-level results (<span class="math notranslate nohighlight">\(c\hat{\beta}\)</span>) become our new dependent variable (<span class="math notranslate nohighlight">\(y^{*}\)</span>):</p>
<div class="amsmath math notranslate nohighlight" id="equation-f6a458c7-8f07-492a-86db-12c9954b351c">
<span class="eqno">(68)<a class="headerlink" href="#equation-f6a458c7-8f07-492a-86db-12c9954b351c" title="Permalink to this equation">¶</a></span>\[\begin{align}
\mathbf{y}^{*} = c\hat{\beta}
\end{align}\]</div>
<p>which is, similar to first-level GLMs, modeled using a (run-level) GLM with a specific run-level design matrix, <span class="math notranslate nohighlight">\(\mathbf{X}^{*}\)</span>, and associated run-level parameters, <span class="math notranslate nohighlight">\(\hat{\beta}^{*}\)</span>:</p>
<div class="amsmath math notranslate nohighlight" id="equation-d5ef357d-410b-4755-8d5c-10e125552059">
<span class="eqno">(69)<a class="headerlink" href="#equation-d5ef357d-410b-4755-8d5c-10e125552059" title="Permalink to this equation">¶</a></span>\[\begin{align}
\mathbf{y}^{*} = \mathbf{X}^{*}\beta^{*} + \epsilon^{*}
\end{align}\]</div>
<p>These run-level parameters are usually estimated using OLS:</p>
<div class="amsmath math notranslate nohighlight" id="equation-2e7619ce-9aec-4df3-bcf0-50d3c68ae87d">
<span class="eqno">(70)<a class="headerlink" href="#equation-2e7619ce-9aec-4df3-bcf0-50d3c68ae87d" title="Permalink to this equation">¶</a></span>\[\begin{align}
\hat{\beta}^{*} = (\mathbf{X}^{*T}\mathbf{X}^{*})^{-1}\mathbf{X}^{*T}\mathbf{y}^{*}
\end{align}\]</div>
<p>Importantly, the way you specify the run-level design matrix, <span class="math notranslate nohighlight">\(\mathbf{X}^{*}\)</span>, dictates the way the data is aggregated, which we’ll come back to later. For now, it is important to understand that the summary statistics approach entails using the results from the previous level (<span class="math notranslate nohighlight">\(c\hat{\beta}\)</span>) as the target/dependent variable (<span class="math notranslate nohighlight">\(\mathbf{y}^{*}\)</span>) in the current level.</p>
<p>In what follows, we’ll explain the process using the previously simulated dataset (with two conditions, “A” and “B”). First of all, we need to run our “first-level” models for the four runs separately.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (2 points): Within a loop, compute the contrast against baseline for both condition "A" ($\beta_{A} > 0$) and condition "B" ($\beta_{B} > 0$) per run and store these results in the pre-allocated <tt>runwise_cb</tt> array, where the first row should represent the $\beta_{A} > 0$ results and the second row should represent the $\beta_{B} > 0$ results. 
<p>Use the variables <tt>Xs</tt> and <tt>ys</tt>, which are both <em>lists</em> of length 4, corresponding to the four runs. Each element in <tt>Xs</tt> contains a <span class="math notranslate nohighlight">\(200\)</span> (N) <span class="math notranslate nohighlight">\(\times\ 2\)</span> (P) array. Each element in <tt>ys</tt> contains a 1D array of size <span class="math notranslate nohighlight">\(200\)</span> (N).</p>
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement your ToDo here. &#39;&#39;&#39;</span>
<span class="c1"># array has shape: num contrasts x N_runs</span>
<span class="n">runwise_cb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xs</span><span class="p">)))</span>

<span class="c1"># Implement your loop here, in which you fill the </span>
<span class="c1"># runwise_cb array with the different </span>
<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nii.week_5</span> <span class="kn">import</span> <span class="n">test_ss_ffx_glm</span>
<span class="n">test_ss_ffx_glm</span><span class="p">(</span><span class="n">Xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">runwise_cb</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In case you couldn’t figure out the previous ToDo, we’ll load in the (approximately) correct <code class="docutils literal notranslate"><span class="pre">runwise_cb</span></code> values below, so we can continue the explanation (note that this will overwrite your own answer, and will give an error if you run the test cell above, but during grading we will only use your own implementation).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runwise_cb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;runwise_cb_answer.npy&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Okay, so within our summary statistics approach, the <span class="math notranslate nohighlight">\(c\hat{\beta}\)</span> values will become our new data (<span class="math notranslate nohighlight">\(y^{*}\)</span>). For now, let’s only focus on the condition “A” against baseline contrast (the first row in <code class="docutils literal notranslate"><span class="pre">runwise_cb</span></code>). Let’s redefine this as <code class="docutils literal notranslate"><span class="pre">y_rl</span></code> (“y, run-level”):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_rl</span> <span class="o">=</span> <span class="n">runwise_cb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>We have defined our dependent variable, but what should our run-level design matrix (<span class="math notranslate nohighlight">\(\mathbf{X}^{*}\)</span>) be? This, of course, depends on what you are interested in. Often, people simply want to aggregate the results across different runs into a single “average” estimate.</p>
<p>It turns out that using a vector of ones as your design matrix (<span class="math notranslate nohighlight">\(\mathbf{X}^{*}\)</span>) will yield run-level parameter estimates (<span class="math notranslate nohighlight">\(\hat{\beta}^{*}\)</span>) that correspond to the average of your first-level results. So, when you use a vector of ones as your run-level design matrix, <span class="math notranslate nohighlight">\(\mathbf{X}^{*}\)</span> …</p>
<div class="amsmath math notranslate nohighlight" id="equation-2b408d9e-a0df-4ecd-bc49-ba72a1e4d173">
<span class="eqno">(71)<a class="headerlink" href="#equation-2b408d9e-a0df-4ecd-bc49-ba72a1e4d173" title="Permalink to this equation">¶</a></span>\[\begin{align}
\mathbf{X}^{*} = \begin{bmatrix}
             1 \\
             1 \\
             \vdots \\
             1
         \end{bmatrix}
\end{align}\]</div>
<p>then the parameter of this run-level GLM will correspond to the average of the first-level results (<span class="math notranslate nohighlight">\(c\hat{\beta}\)</span>):</p>
<div class="amsmath math notranslate nohighlight" id="equation-08ab3d4f-6c0f-409a-915a-4e63cf6bce07">
<span class="eqno">(72)<a class="headerlink" href="#equation-08ab3d4f-6c0f-409a-915a-4e63cf6bce07" title="Permalink to this equation">¶</a></span>\[\begin{align}
\mathrm{average}(c\hat{\beta}) = \hat{\beta}^{*} = (\mathbf{X}^{*T}\mathbf{X}^{*})^{-1}\mathbf{X}^{*T}y^{*}
\end{align}\]</div>
<p>So, why is this design — in which the average is just a vector of ones for each run — modelling the average of the first-level results? Well, let’s investigate this using our previously simulated data. Now, we know that our GLM (with a vector of ones) should give us the mean. Let’s calculate the mean ‘manually’ so that we can check later whether the GLM gives us the same answer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">manual_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_rl</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">manual_mean</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.1345866603263484
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
<b>ToDo</b> (1 point): Create a design-matrix of shape $(4, 1)$, in which the single column contains all ones (you can use the <tt>np.ones</tt> function for this!). Then run linear regression using the variable <tt>y_rl</tt> as our target and the using the design-matrix you just created (representing the "$\mathbf{X}$"). Store the resulting parameter-value in a variable named <tt>glm_mean</tt>.  
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement your ToDo here.&#39;&#39;&#39;</span>
<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo.&#39;&#39;&#39;</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">glm_mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">glm_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">glm_mean</span>

<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span> <span class="n">manual_mean</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Well done!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If you’ve done the previous ToDo correctly, you’ve seen that, as expected, the parameter calculated by the GLM when using a predictor with all ones (a run-level intercept, basically) reflects the mean of the dependent-variable. In fact, in the context of the GLM — which aims to minimize the residuals between the predictor(s) and the target — this makes sense! We show you this in the plot below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rnge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_rl</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_rl</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_rl</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_rl</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_run</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_run</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="sa">r</span><span class="s1">&#39;$Y^{*}$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$X^{*}$&#39;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_run</span><span class="o">+</span><span class="mi">1</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_run</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_rl</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">rnge</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Contrast-values ($c\beta$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Runs&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Run-level GLM model&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Run-level *fitted* GLM model&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">manual_mean</span><span class="p">,</span> <span class="n">n_run</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_run</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_run</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">y_rl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">manual_mean</span><span class="p">),</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">manual_mean</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&gt;&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\hat{\beta}^{*}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="sa">r</span><span class="s1">&#39;$Y^{*}$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$X^{*}$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\hat</span><span class="si">{Y}</span><span class="s1">^{*} = \hat{\beta}^{*}$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$residuals^{*}$&#39;</span><span class="p">],</span>
                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
        
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/run_level_analyses_35_0.png" src="../../_images/run_level_analyses_35_0.png" />
</div>
</div>
<p>From the plot above, you can nicely see that the vector of ones nicely models the mean of the dependent variable (the first-level <span class="math notranslate nohighlight">\(\beta_{A} &gt; 0\)</span> contrasts). Just like in first-level models, we can specify particular <strong>run-level</strong> contrasts. Implicitly, we used a <strong>run-level</strong> contrast against baseline here (because for our single run-level predictor, when <span class="math notranslate nohighlight">\(c^{*} = [1]\)</span>, then <span class="math notranslate nohighlight">\(c\hat{\beta}^{*} = \hat{\beta}^{*}\)</span>), but other contrasts are definitely possible (we’ll take a look at that later).</p>
<p>But what if we want to test more than one <em>first-level</em> contrast, eventually, at the group-level? For example, suppose we also want to test <span class="math notranslate nohighlight">\(\beta_{B} &gt; 0\)</span>. Should we then just run a <em>separate</em> run-level analysis for each first-level contrast? You surely can, but often it’s easier to do it in a single model in which we concatenate the contrast-values from the different contrasts. We do this below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># order: A1, A2, A3, A4, B1, B2, B3, B4</span>
<span class="n">y_AB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">runwise_cb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">runwise_cb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">runwise_cb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_run</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">runwise_cb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_run</span><span class="p">,</span> <span class="n">n_run</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:green&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_run</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;Run &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_run</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Runs&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Contrast-values ($c\hat{\beta}$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Concatenated contrast-values, A and B&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="sa">r</span><span class="s1">&#39;$Y_</span><span class="si">{A}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$Y_</span><span class="si">{B}</span><span class="s1">$&#39;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/run_level_analyses_37_0.png" src="../../_images/run_level_analyses_37_0.png" />
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (2 points): Now, given the concatenated data (the variable <tt>y_AB</tt>), can you come up with a design-matrix ($X$) that models both the mean of the contrast-values of A-against-baseline (first four values) and the contrast-values of B-against-baseline (last four values)? Name your design-matrix <tt>X_concat_data</tt> (hint: it needs two columns), which should be a 2D numpy array. Then, run linear regression on the concatenated data using your design-matrix (<tt>X_concat_data</tt>); you can check your answer by verifying that the two parameters from the run-level regression model are the same as the mean across the columns of the <tt>runwise_cb</tt> array.
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement your ToDo here. &#39;&#39;&#39;</span>
<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nii.week_5</span> <span class="kn">import</span> <span class="n">test_concat_design</span>
<span class="n">test_concat_design</span><span class="p">(</span><span class="n">n_run</span><span class="p">,</span> <span class="n">X_concat_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (1 point): Right now, we only have the <em>first-level</em> contrasts against baseline to our disposal ($\beta_{A} > 0$ and $\beta_{B} > 0$). But suppose that I'm actually interested to see which voxels significantly activate in response to both stimuli across runs, i.e., $(\beta_{A} > 0)\ \&\ (\beta_{B} > 0)$. We can actually specify a particular <em>run-level</em> contrast that tests this. Create an array (with size 2) that implements this contrast vector, and store it in a variable named <em>cvec_A_and_B</em>.
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement your ToDo here. &#39;&#39;&#39;</span>
<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the ToDo above. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nii.week_5</span> <span class="kn">import</span> <span class="n">test_cvec_A_and_B</span>    
<span class="n">test_cvec_A_and_B</span><span class="p">(</span><span class="n">cvec_A_and_B</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (optional, bonus point): Suppose that, for some reason, I'm interested in investigating whether there are voxels that respond more strongly to condition "A" in the first two sessions than the last two sessions. Given our first-level results (stored in <tt>y_AB</tt>), how should my run-level design matrix ($\mathbf{X}_{rl}$) and run-level contrast vector look like? For a bonus point, create this matrix and contrast vector below, run linear regression on the run-level data (<tt>y_AB</tt>) using your design matrix, and compute the run-level contrast using your contrast vector. Store the result of this run-level contrast (i.e., a single nubmer) in a variable named <tt>runlevel_cb_optional</tt>.
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement the (optional) ToDo here. &#39;&#39;&#39;</span>
<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the ToDo above. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nii.week_5</span> <span class="kn">import</span> <span class="n">test_runlevel_cb_optional</span>
<span class="n">test_runlevel_cb_optional</span><span class="p">(</span><span class="n">runlevel_cb_optional</span><span class="p">,</span> <span class="n">y_AB</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fixed-vs-random-vs-mixed-effects">
<h3>Fixed vs. random vs. mixed effects<a class="headerlink" href="#fixed-vs-random-vs-mixed-effects" title="Permalink to this headline">¶</a></h3>
<p>Remember that we told you that hierarchical data, such as multi-subject fMRI data, is often analyzed with mixed models which compute the variance (uncertainty) of the effects using the variance estimates at each level within your model. This specific type of analysis, in which the final variance estimate is computed using variance components across all levels, is often called a <strong>mixed-effects analysis</strong>.</p>
<p>In the run-level models so far, though, we only focused on the run-level <em>effects</em> (<span class="math notranslate nohighlight">\(c\hat{\beta}_{rl}\)</span>), not their variance! In fact, for run-level analyses, it is common to “ignore” the run-level variance and simply average the first-level variance estimates across runs. In other words, this is treating the effect as “fixed” across runs and assuming the variance per run is similar (so that these variance estimates can be average). This specific analysis, in which the effect is assumed to be fixed across observations within an analysis level (e.g., across runs), is often called a <strong>fixed-effects analysis</strong>. Just like the mixed-effects analysis, they are all (variations on) the GLM with specific ways in which they estimate the variance component of our effects.</p>
<p>In the context of analysis of hierarchical fMRI data, <strong>fixed-effects analyses</strong> at the run-level are completely reasonable (at least, that’s what most people do in practice). However, this is not true for the next level in our summary statistics approach: the group-level. Here, you actually need to incorporate the variance component from the group-level in order to draw valid population inferences. When you incorporate this group-level variance component, but ignore the lower-level variance components (i.e., at the first-level or run-level), this type of analysis is not a full mixed-effects analysis, but is often called a <strong>random-effects analysis</strong>. This is the approach that SPM takes (which is fine, given some assumptions). FSL, on the other hand, offers both random-effects as well as a full mixed-effects option, in which the latter is estimated by incorporating both first-level (or run-level) and group-level variance estimates (which approximates the “proper” mixed model without the summary statistics procedure).</p>
<p>But let’s not get distracted (group-level models is the topic of next week!) and continue with this notebook’s last section on how to implement run-level (fixed-effects) analyses in FSL.</p>
</div>
<div class="section" id="run-level-analyses-in-fsl">
<h3>Run-level analyses in FSL<a class="headerlink" href="#run-level-analyses-in-fsl" title="Permalink to this headline">¶</a></h3>
<p>In FSL, any analysis that is not at the first-level is called a “higher-level analysis”. In this section, we are going to set up such a higher-level analysis with the goal to average our first-level <code class="docutils literal notranslate"><span class="pre">flocBLOCKED</span></code> results. In particular, we are going to do this specifically for the following contrasts:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(4\times\beta_{\mathbf{face}} - \beta_{body} - \beta_{place} - \beta_{character} - \beta_{object} &gt; 0\)</span> contrast (this was contrast number 4 in our original first-level analysis)</p></li>
<li><p><span class="math notranslate nohighlight">\(4\times\beta_{\mathbf{place}} - \beta_{body} - \beta_{face} - \beta_{character} - \beta_{object} &gt; 0\)</span> contrast (this was contrast number 5 in our original first-level analysis).</p></li>
</ul>
<div class='alert alert-warning'>
<b>ToDo</b> (not graded): Open FEAT and change the type of analysis from "First-level analysis" to "Higher-level analysis". 
</div><p>You should see that the “Pre-stats” and “Registration” tabs become unavailable, as FEAT assumes these things have been done in the first-level analyses.</p>
<div class='alert alert-warning'>
<b>ToDo</b> (not graded): First, go to the "Stats" tab and change the analysis-type from "Mixed effects: FLAME 1" to "Fixed effects". 
</div><p>Now, let’s tell FEAT which data we want to analyze. For the upcoming ToDos, we’re going to average the “face &gt; other” and “place &gt; other” contrasts. The two first-level analyses (one for each run) have been run already and are located here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span> <span class="s1">&#39;NI-edu-data&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting download of FEAT directory (+- 287MB) ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="o">!</span>aws s3 sync --no-sign-request s3://openneuro.org/ds003477 <span class="o">{</span>data_dir<span class="o">}</span> --exclude <span class="s2">&quot;*&quot;</span> --include <span class="s2">&quot;derivatives/fsl/sub-03/flocBLOCKED/ses-2.feat/*&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Starting download of FEAT directory (+- 287MB) ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feat_r1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;fsl&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-03&#39;</span><span class="p">,</span> <span class="s1">&#39;flocBLOCKED&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-1.feat&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The run 1 results are here: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">feat_r1</span><span class="p">)</span>
<span class="n">feat_r2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;fsl&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-03&#39;</span><span class="p">,</span> <span class="s1">&#39;flocBLOCKED&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-2.feat&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The run 2 results are here: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">feat_r2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The run 1 results are here: /home/jupyter-niadmin/NI-edu-data/derivatives/fsl/sub-03/flocBLOCKED/ses-1.feat
The run 2 results are here: /home/jupyter-niadmin/NI-edu-data/derivatives/fsl/sub-03/flocBLOCKED/ses-2.feat
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
<b>ToDo</b> (not graded): 
<p>Change the setting “Inputs are lower-level FEAT directories” to “Inputs are 3D cope images from FEAT directories”. Set the “Number of inputs” to 4. Then, press the “Select cope images” button and add the different first-level contrast estimate files. The order should be: “face &gt; other” (session 1), “face &gt; other” (session 2), “place &gt; other” (session 1), and “place &gt; other” (session 2):</p>
<div class="amsmath math notranslate nohighlight" id="equation-97348a32-f769-4191-8d6d-4f12aa0619e5">
<span class="eqno">(73)<a class="headerlink" href="#equation-97348a32-f769-4191-8d6d-4f12aa0619e5" title="Permalink to this equation">¶</a></span>\[\begin{align}
y^{*} = 
\begin{bmatrix}
c\hat{\beta}_{\mathrm{face&gt;other,\ session\ 1}} \\
c\hat{\beta}_{\mathrm{face&gt;other,\ session\ 2}} \\
c\hat{\beta}_{\mathrm{place&gt;other,\ session\ 1}} \\
c\hat{\beta}_{\mathrm{place&gt;other,\ session\ 2}} \\
\end{bmatrix}
\end{align}\]</div>
<p>Check the ToDo in section 4.1.4. to see which contrast (“COPE”) numbers these first-level contrasts refer to.
Set the “Output directory” to the “week 5” folder. And, under the “Post-stats” tab, set the thresholding to “Uncorrected” at a threshold at <span class="math notranslate nohighlight">\(p &lt; 0.005\)</span>.</p>
</div><p>Note that, instead of assuming that “Inputs are 3D cope images from FEAT directions”, you could use the other option “Inputs are lower-level FEAT directories”. This option allows you to apply a particular higher-level design (<span class="math notranslate nohighlight">\(\mathbf{X}^{*}\)</span>) and higher-level contrasts (<span class="math notranslate nohighlight">\(\mathbf{c}^{*}\)</span>) for <em>all first-level contrasts</em> at the same time. Here, we don’t use this option as it is less clear what is happening “under the hood”.</p>
<div class='alert alert-danger'>
<b>Assignment</b> (2 points)<br>
<p>In the “Stats” tab, click on the “Full model setup” button. Now, you can directly specify your design matrix (<span class="math notranslate nohighlight">\(\mathbf{X}^{*}\)</span>) here in the “EVs” tab. Here, create a design matrix that allow you to average the first-level “face &gt; other” and “place &gt; other” contrasts within a (single) run-level GLM (hint: you might need to change the “Number of main EVs”). Then, go to the “Contrasts and F-tests” tab and create the contrasts that you need in order to average the “face &gt; other” first-level contrast across runs and the “place &gt; other” first-level contrast across runs. Give the EVs and contrasts sensible names.</p>
<p>When you’re happy with your setup, save your setup in your <tt>week_5</tt> directory; give it the name <tt>setup_feat_runlevel</tt>. Then, add the following line to the text-cell below:</p>
<p><code class="docutils literal notranslate"><span class="pre">![](setup_feat_runlevel.png)</span></code></p>
<p>After adding this line and running the cell, the run-level design should be visible. If it is not, you probably saved the design in the wrong directory.</p>
</div><p>YOUR ANSWER HERE</p>
</div>
</div>
<div class="section" id="checking-out-results-from-run-level-feat-analyses">
<h2>Checking out results from run-level FEAT analyses<a class="headerlink" href="#checking-out-results-from-run-level-feat-analyses" title="Permalink to this headline">¶</a></h2>
<p>We actually already ran the run-level analysis, of which the results are| downloaded in the cell below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting download of runlevel FEAT directory (+- 40MB) ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="o">!</span>aws s3 sync --no-sign-request s3://openneuro.org/ds003477 <span class="o">{</span>data_dir<span class="o">}</span> --exclude <span class="s2">&quot;*&quot;</span> --include <span class="s2">&quot;derivatives/fsl/sub-03/flocBLOCKED/runlevel_Week5.gfeat/*&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done!&quot;</span><span class="p">)</span>

<span class="n">runlevel_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;fsl&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-03&#39;</span><span class="p">,</span> <span class="s1">&#39;flocBLOCKED&#39;</span><span class="p">,</span> <span class="s1">&#39;runlevel_Week5.gfeat&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">runlevel_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Starting download of runlevel FEAT directory (+- 40MB) ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done!
/home/jupyter-niadmin/NI-edu-data/derivatives/fsl/sub-03/flocBLOCKED/runlevel_Week5.gfeat
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b>: Open a terminal and navigate to the above <tt>runlevel_Week5.gfeat</tt> directory (using <tt>cd</tt>). Then, print its contents to the terminal window (using <tt>ls</tt>)!
</div><p>The <code class="docutils literal notranslate"><span class="pre">gfeat</span></code> suffix stands for “group FEAT” and is appended to each higher-level analysis output directory (i.e., any analysis that is not a first-level analysis).</p>
<p>In this <code class="docutils literal notranslate"><span class="pre">gfeat</span></code> directory, you should see similar files as you’ve seen in first-level FEAT directories: HTML-files with analysis summaries, files with design information, etc.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): In your terminal, open the <tt>report.html</tt> file in the <tt>gfeat</tt> directory with Firefox, which should open a new Firefox window. Then, click on the "Registration summary" tab.
</div><p>The registration tab conveniently shows us the “functional → standard space” registration results again, but now for all four runs at the same time. Here you can easily check for possible large registration differences between runs/sessions. Note that this particular transformation is only executed in higher-level analyses. While the (linear and non-linear) registration parameters are already <em>computed</em> in the first-level analysis, they are <em>applied</em> in the higher-level analysis.</p>
<div class='alert alert-info'>
    <b>ToThink</b> (ungraded): Can you think of a reason why spatial resampling to standard space is postponed to the higher-level stage?
</div><p>If you scroll further down, you see a figure with the caption “Sum of all input masks after transformation to standard space”. This shows you how well the functional brain masks (delineating brain from non-brain matter, i.e., the skullstripping result for the different functional files) align. It uses a red-yellow colormap from 1 (red) to 4 (yellow), showing where all masks overlap (yellow) and where this is not the case (relatively red voxels). There are some voxels not included in all masks in orbitofrontal cortex (visible in the first row of brain slices), which might be caused by different amounts of signal dropout across runs, but that isn’t much of a problem.</p>
<p>The figure below (“Unique missing-mask voxels”) is a similar quality check, where it plots voxels missing in precisely <em>one</em> mask, which allows you to easily spot whether a single registration did not work as expected. Here, everything looks alright.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Click on the "Results" tab. Note that the image of the design matrix is missing, because we have deleted this (as it would give away the answer to the previous assignment). Now, click on the "Higher-level FEAT results" link, which will open the "post-stats" tab of the higher-level FEAT analysis. Here, you can see two figures, showing the (thresholded) results of our run-level contrasts ($c\hat{\beta}^{*}$).
</div><p>Within the <code class="docutils literal notranslate"><span class="pre">gfeat1</span></code> directory, of particular interest is the <code class="docutils literal notranslate"><span class="pre">cope1.feat</span></code> directory. This subdirectory contains the actual <em>results</em> of the run-level analysis. The reason this directory is called <code class="docutils literal notranslate"><span class="pre">cope1.feat</span></code> is because the other input option (“Inputs are lower-level FEAT directories”) allows you to apply the higher-level design to multiple lower-level contrasts at the same time, which would create separate <code class="docutils literal notranslate"><span class="pre">cope*.feat</span></code> subdirectories (<code class="docutils literal notranslate"><span class="pre">cope1.feat</span></code>, <code class="docutils literal notranslate"><span class="pre">cope2.feat</span></code>, <code class="docutils literal notranslate"><span class="pre">cope3.feat</span></code>, etc.). The “Inputs are 3D cope images from FEAT directories” option only creates a single directory which is by default called <code class="docutils literal notranslate"><span class="pre">cope1.feat</span></code>.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): In your terminal, navigate into the <tt>cope1.feat</tt> directory and print its contents to the terminal window.
</div><p>Here, you see that this <code class="docutils literal notranslate"><span class="pre">cope1.feat</span></code> subdirectory has the exact same structure and files as the first-level <code class="docutils literal notranslate"><span class="pre">.feat</span></code> directories that we inspected earlier!</p>
<p>Let’s view the results in FSLeyes.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Close any active overlays (Overlay &rarr; Remove all). Then, click on File &rarr; Add standard &rarr; click on <tt>MNI152_T1_2mm_brain.nii.gz</tt>, which is the standard space image that FSL used as the group template. Then, add the <tt>thresh_zstat1.nii.gz</tt> image from the <tt>cope1.feat</tt> directory (i.e., <tt>runlevel.gfeat/cope1.feat/thresh_zstat1.nii.gz</tt>). This file corresponds to the (thresholded) fixed-effects "average" effect of our lower-level $\beta_{face} > 0$ contrasts.
<p>Change the colormap to “Red-Yellow”.</p>
</div><p>Viewing results from run-level analyses is not fundamentally different from first-level analyses, with one exception: the data is now in “standard space” (i.e., MNI152, 2mm space). This allows us to use <em>atlases</em> to connect the location of our effects to particular anatomical brain regions.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): In the top menu, click on Settings &rarr; Ortho View 1 &rarr; Atlas panel. This should open a new panel in between the Overlay list and the Location panel.
</div><p>The Atlases panel by default has to to atlases loaded: the <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/Atlases">Harvard-Oxford Cortical Structural atlas</a> and the Harvard-Oxford Subcortical Structural atlas, which are based on the individual segmentations of 37 T1-weighted scans.</p>
<p>Importantly, these atlases are <em>probabilistic</em>, meaning that, for each voxel, they give a <em>probability</em> (or, actually, percentage) of belonging to a particular (set of) region(s). The exact percentage is based on the number of people (out of 37) in which that voxel belonged to that region. So, if, for a particular voxel, the atlas shows you “82% left amygdala”, that means that that voxel was part of the left amygdala for 81% of those 37 people.</p>
<p>Consequently, most voxels actually have multiple labels (e.g., 81% left amygdala, 19% left hippocampus).</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Go to voxel $[25, 39, 25]$ and check out the regions listed in the atlas panel. Do you expect to find this region for this particular contrast/analysis?
</div><div class='alert alert-success'>
    <b>Tip!</b>
    Before handing in your notebooks, we recommend restarting your kernel (<em>Kernel</em> &rarr; <em>Restart & Clear Ouput</em>) and running all your cells again (manually, or by <em>Cell</em> &rarr; <em>Run all</em>). By running all your cells one by one (from "top" to "bottom" of the notebook), you may spot potential errors that are caused by accidentally overwriting your variables or running your cells out of order (e.g., defining the variable 'x' in cell 28 which you then use in cell 15).
</div></div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./fMRI-introduction/week_5"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="first_level_analyses.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">First-level analyses (using FSL)</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="../../section_intros/6_grouplevel.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Group-level analyses</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Lukas Snoek<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>